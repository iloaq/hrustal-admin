# –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## üîç –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–æ–±–ª–µ–º

### 1. **–î–≤–æ–π–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤ `/api/leads`**
```typescript
// –ü–†–û–ë–õ–ï–ú–ê: –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –¥–≤–∞–∂–¥—ã
const leads = await prisma.lead.findMany({...}); // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
// ... –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ ...
const updatedLeads = await prisma.lead.findMany({...}); // –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å - —Ç–æ –∂–µ —Å–∞–º–æ–µ!
```

### 2. **N+1 –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏**
```typescript
// –ü–†–û–ë–õ–ï–ú–ê: –í —Ü–∏–∫–ª–µ –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞—è–≤–∫–∏ –¥–µ–ª–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
for (const lead of leads) {
  await autoAssignTruckByRegion(lead); // –í–Ω—É—Ç—Ä–∏ –¥–µ–ª–∞–µ—Ç upsert
}
```

### 3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤**
–ù—É–∂–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
- `delivery_date` –≤ —Ç–∞–±–ª–∏—Ü–µ `leads`
- `created_at` –≤ —Ç–∞–±–ª–∏—Ü–µ `leads`
- `lead_id + status` –≤ —Ç–∞–±–ª–∏—Ü–µ `truck_assignments`

### 4. **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è**
BigInt –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç—Å—è –≤ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ –æ—Ç–¥–µ–ª—å–Ω–æ.

## ‚úÖ –ü–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –£–±—Ä–∞—Ç—å –¥–≤–æ–π–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
**–†–µ—à–µ–Ω–∏–µ:** –û–±–Ω–æ–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏ –≤–º–µ—Å—Ç–æ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

### üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ü–∞–∫–µ—Ç–Ω–æ–µ –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** N+1 –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–±—Ä–∞—Ç—å –≤—Å–µ –Ω–æ–≤—ã–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏ —Å–¥–µ–ª–∞—Ç—å batch insert

### üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –¥–∞—Ç–∞–º
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã

### üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–∞—Å—Ç–æ
**–†–µ—à–µ–Ω–∏–µ:** In-memory –∫—ç—à –Ω–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è

### üöÄ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 5: –ü–∞–≥–∏–Ω–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏ —Å—Ä–∞–∑—É
**–†–µ—à–µ–Ω–∏–µ:** –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤

## üîß –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è `/api/leads` route
```typescript
// –ë–´–õ–û
const leads = await prisma.lead.findMany({...});
// –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Ü–∏–∫–ª–µ
const updatedLeads = await prisma.lead.findMany({...}); // –î—É–±–ª—å!

// –°–¢–ê–ù–ï–¢
const leads = await prisma.lead.findMany({...});
const batchAssignments = prepareBatchAssignments(leads);
if (batchAssignments.length > 0) {
  await prisma.truckAssignment.createMany({ data: batchAssignments });
  // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏ –±–µ–∑ –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
  updateLeadsInMemory(leads, batchAssignments);
}
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
```sql
-- –î–ª—è –±—ã—Å—Ç—Ä—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ –¥–∞—Ç–µ –¥–æ—Å—Ç–∞–≤–∫–∏
CREATE INDEX idx_leads_delivery_date ON leads(delivery_date);

-- –î–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ created_at
CREATE INDEX idx_leads_created_at ON leads(created_at);

-- –°–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è truck_assignments
CREATE INDEX idx_truck_assignments_lead_status ON truck_assignments(lead_id, status);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π
CREATE INDEX idx_truck_assignments_status_assigned ON truck_assignments(status, assigned_at);
```

### 3. –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
```typescript
// –í–º–µ—Å—Ç–æ —Ü–∏–∫–ª–∞ —Å await
for (const lead of leads) {
  await autoAssignTruckByRegion(lead); // –ú–µ–¥–ª–µ–Ω–Ω–æ!
}

// –î–µ–ª–∞–µ–º batch –æ–ø–µ—Ä–∞—Ü–∏—é
const assignments = leads
  .filter(lead => !hasActiveAssignment(lead))
  .map(lead => createAssignment(lead));

await prisma.truckAssignment.createMany({
  data: assignments,
  skipDuplicates: true
});
```

### 4. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```typescript
const cache = new Map();
const CACHE_TTL = 30000; // 30 —Å–µ–∫—É–Ω–¥

export async function getCachedLeads(date: string) {
  const cacheKey = `leads_${date}`;
  const cached = cache.get(cacheKey);
  
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.data;
  }
  
  const data = await prisma.lead.findMany({...});
  cache.set(cacheKey, { data, timestamp: Date.now() });
  return data;
}
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | –£–ª—É—á—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ | –°–ª–æ–∂–Ω–æ—Å—Ç—å |
|-------------|-------------------|-----------|
| –£–±—Ä–∞—Ç—å –¥–≤–æ–π–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã | 50% | –ù–∏–∑–∫–∞—è |
| –ü–∞–∫–µ—Ç–Ω–æ–µ –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ | 70% | –°—Ä–µ–¥–Ω—è—è |
| –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã | 80% | –ù–∏–∑–∫–∞—è |
| –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ | 90% | –°—Ä–µ–¥–Ω—è—è |
| –ü–∞–≥–∏–Ω–∞—Ü–∏—è | 60% | –í—ã—Å–æ–∫–∞—è |

## üéØ –ü–æ—Ä—è–¥–æ–∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –§–∞–∑–∞ 1 (–ë—ã—Å—Ç—Ä—ã–µ –ø–æ–±–µ–¥—ã)
1. ‚úÖ –£–±—Ä–∞—Ç—å –¥–≤–æ–π–Ω–æ–π –∑–∞–ø—Ä–æ—Å –≤ `/api/leads`
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è BigInt

### –§–∞–∑–∞ 2 (–°—Ä–µ–¥–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏—è)  
4. ‚úÖ –ü–∞–∫–µ—Ç–Ω–æ–µ –∞–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ
5. ‚úÖ –ü—Ä–æ—Å—Ç–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

### –§–∞–∑–∞ 3 (–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ)
6. ‚è≥ –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤
7. ‚è≥ Redis –∫—ç—à –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
8. ‚è≥ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è JSON –ø–æ–ª–µ–π

## üî¨ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏–∑–º–µ—Ä—è—Ç—å:
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API endpoints
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î

## üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã

- **Prisma metrics** - –≤—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- **Database slow query log** - –ª–æ–≥–∏ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤  
- **Browser DevTools** - –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ
- **Console.time()** - –∏–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è 